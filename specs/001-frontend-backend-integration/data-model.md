# Data Model: Frontend-Backend Integration & Embedded Chatbot

## Entity: User Query

### Description
Represents a question or query submitted by the user through the chatbot interface.

### Fields
- `id`: Unique identifier for the query (string, required)
- `text`: The actual question text (string, required)
- `type`: Type of query - "normal" or "selected-text" (enum, required)
- `selectedText`: Text that was selected/highlighted by the user (string, optional)
- `pageContext`: URL or identifier of the current page (string, optional)
- `timestamp`: When the query was submitted (datetime, required)
- `context`: Additional context provided with the query (string, optional)

### Validation Rules
- Text must be between 1 and 1000 characters
- Type must be one of the allowed values
- Selected text, if present, must be part of the page content

## Entity: Chatbot Response

### Description
Represents the response generated by the backend AI agent based on the user query.

### Fields
- `id`: Unique identifier for the response (string, required)
- `answer`: The main answer text (string, required)
- `sources`: List of source citations (array of Source objects, required)
- `confidence`: Confidence score for the response (number between 0 and 1, required)
- `timestamp`: When the response was generated (datetime, required)
- `queryId`: Reference to the original query (string, required)

### Validation Rules
- Answer must be present and non-empty
- Sources array must contain at least one source for valid responses
- Confidence must be between 0 and 1
- Query ID must reference an existing query

## Entity: Source

### Description
Represents a citation to specific content in the book that supports the chatbot's response.

### Fields
- `id`: Unique identifier for the source (string, required)
- `content`: The actual text content from the book (string, required)
- `location`: Reference to the location in the book (e.g., chapter, section) (string, required)
- `score`: Similarity score between query and source (number between 0 and 1, required)
- `url`: URL to navigate to the source location (string, required)

### Validation Rules
- Content must be non-empty
- Location must be a valid reference in the book
- Score must be between 0 and 1
- URL must be a valid internal link to book content

## Entity: Conversation

### Description
Represents a sequence of related queries and responses between a user and the chatbot.

### Fields
- `id`: Unique identifier for the conversation (string, required)
- `userId`: Identifier for the user (string, optional)
- `sessionId`: Session identifier for anonymous users (string, required)
- `messages`: List of messages in the conversation (array of Message objects, required)
- `createdAt`: When the conversation started (datetime, required)
- `updatedAt`: When the conversation was last updated (datetime, required)

### Validation Rules
- Messages array must not exceed 100 items
- Session ID must be unique per user
- Updated timestamp must be equal to or later than created timestamp

## Entity: Message

### Description
Represents a single message in a conversation, either from the user or the chatbot.

### Fields
- `id`: Unique identifier for the message (string, required)
- `conversationId`: Reference to the parent conversation (string, required)
- `sender`: "user" or "bot" (enum, required)
- `content`: The message content (string, required)
- `timestamp`: When the message was sent/received (datetime, required)
- `type`: Message type - "query", "response", "error" (enum, required)

### Validation Rules
- Sender must be one of the allowed values
- Content must be non-empty
- Timestamp must be within the conversation timeframe

## Entity: Selected Text Context

### Description
Represents the text selected by the user on a book page that is used as context for queries.

### Fields
- `id`: Unique identifier for the selection (string, required)
- `text`: The selected/highlighted text (string, required)
- `pageUrl`: URL of the page where text was selected (string, required)
- `selectionStart`: Character position where selection started (number, required)
- `selectionEnd`: Character position where selection ended (number, required)
- `surroundingText`: Context around the selection (string, optional)
- `timestamp`: When the text was selected (datetime, required)

### Validation Rules
- Text must be non-empty
- Page URL must be a valid book page
- Selection start must be less than selection end
- Selection positions must be within the page content length